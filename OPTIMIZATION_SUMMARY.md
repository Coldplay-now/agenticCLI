# AgentCLI 代码生成优化总结

## 错误共性分析

在 `snake3` 项目中发现的错误具有以下共性：

### 1. **缺少必要的 Python 包结构文件**
- **问题**：缺少 `__init__.py` 和 `__main__.py` 文件
- **影响**：无法作为 Python 包导入，无法通过 `python -m package_name` 运行
- **原因**：AI 在生成代码时没有考虑到 Python 包的标准结构要求

### 2. **导入错误**
- **问题**：导入了不存在的模块或函数（如 `from .core import main_function`）
- **影响**：运行时出现 `ImportError` 或 `ModuleNotFoundError`
- **原因**：代码生成时没有验证导入的模块和函数是否真实存在

### 3. **代码格式问题**
- **问题**：生成的代码包含 markdown 代码块标记（如 ````python`）
- **影响**：代码无法直接运行，需要手动清理
- **原因**：AI 输出时可能包含了 markdown 格式的代码块标记

### 4. **上下文信息不足**
- **问题**：代码生成时没有充分利用已创建的文件信息
- **影响**：生成的代码无法正确引用已创建的模块和函数
- **原因**：代码生成提示词中缺少对已创建文件的详细分析

## 优化措施

### 1. 增强代码生成提示词 (`agentcli/ai_client.py`)

#### 1.1 添加代码格式要求
- 明确要求输出纯 Python 代码，不包含 markdown 代码块标记
- 强调代码应该从第一行开始就是有效的 Python 代码

#### 1.2 添加导入验证要求
- 要求 AI 必须检查已创建的文件列表
- 确保导入的模块和函数确实存在
- 提供具体的错误示例（如不要导入不存在的 `core.main_function`）

#### 1.3 添加 Python 包结构要求
- 明确说明 `__init__.py` 和 `__main__.py` 的作用
- 要求确保包结构文件的正确性

#### 1.4 增强已创建文件信息
- 显示已创建文件的完整内容（限制长度避免过长）
- **新增**：自动提取并显示已创建文件中的函数、类和变量列表
- 方便 AI 验证导入的有效性

### 2. 添加代码清理功能 (`agentcli/ai_client.py`)

新增 `_clean_generated_code()` 方法：
- 自动移除 markdown 代码块标记（````python`, ````py`, ````）
- 清理多余的空行
- 确保代码格式正确

### 3. 更新系统提示词 (`systemprompt.md`)

#### 3.1 添加 Python 包结构说明
- 在任务规划要求中明确说明需要 `__init__.py` 和 `__main__.py`
- 在模板结构说明中标注这些文件的作用

#### 3.2 添加重要提示
- 说明 `__init__.py` 必须包含 `__version__`
- 说明 `__main__.py` 的标准格式
- 说明 CLI 文件的导入要求

## 优化效果

### 预期改进

1. **代码格式正确性**：自动清理 markdown 标记，确保生成的代码可以直接运行
2. **导入准确性**：通过提供已创建文件的函数/类列表，AI 可以验证导入的有效性
3. **包结构完整性**：通过明确的提示词要求，确保生成必要的包结构文件
4. **上下文利用**：通过显示已创建文件的详细内容，AI 可以生成更准确的代码

### 技术细节

#### 已创建文件分析功能
```python
# 自动提取已创建文件中的可导入内容
functions = re.findall(r'^def\s+(\w+)\s*\(', content, re.MULTILINE)
classes = re.findall(r'^class\s+(\w+)', content, re.MULTILINE)
variables = re.findall(r'^__version__\s*=', content, re.MULTILINE)
```

#### 代码清理功能
```python
# 移除 markdown 代码块标记
code = re.sub(r'^```(?:python|py)?\s*\n', '', code, flags=re.MULTILINE)
code = re.sub(r'\n```\s*$', '', code, flags=re.MULTILINE)
```

## 新增验证功能（已完成）

### 1. 代码验证模块 (`agentcli/utils/code_validator.py`)

#### 功能
- **语法验证**：使用 `ast.parse()` 验证 Python 代码语法
- **导入验证**：检查导入的模块和函数是否存在
- **包结构验证**：检查必要的包结构文件（`__init__.py`, `__main__.py`）
- **Markdown 标记检测**：检测代码中是否还有 markdown 代码块标记

#### 集成点
- 代码生成后立即验证（`task_executor.py`）
- 任务执行完成后检查包结构
- 验证结果实时显示在控制台

### 2. 验证流程

```
代码生成 → 清理 markdown 标记 → 语法验证 → 导入验证 → 创建文件 → 包结构检查
```

## 未来改进建议

1. **自动修复**：对于简单的错误（如缺少 `__init__.py`），自动生成修复
2. **模板增强**：为常见的包结构文件（`__init__.py`, `__main__.py`）创建模板
3. **代码质量检查**：集成代码检查工具（如 `flake8`）验证生成的代码
4. **增量生成**：支持在已有项目基础上增量生成代码，更好地利用现有代码
5. **导入自动修复**：检测到导入错误时，自动建议正确的导入路径

## 总结

通过以上优化，AgentCLI 现在能够：
- ✅ 自动清理代码格式问题
- ✅ 提供更详细的上下文信息（已创建文件的函数/类列表）
- ✅ 明确要求生成必要的包结构文件
- ✅ 强调导入验证的重要性

这些改进应该能够显著减少类似错误的出现，提高代码生成的质量和可用性。

